{% extends "base.html" %} {% from "macros/currency.html" import format_currency
%} {% block title %}Minhas Metas{% endblock %} {% block head %}
<!-- Adiciona as bibliotecas necessárias -->
<script src="https://unpkg.com/imask" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
{% endblock %} {% block content %}
<div class="row mb-4">
  <div class="col">
    <h1 class="display-4">Minhas Metas</h1>
  </div>
  <div class="col-auto d-flex gap-2">
    <form
      method="POST"
      action="{{ url_for('goals.reprocess') }}"
      style="display: inline"
    >
      <button
        type="submit"
        class="btn btn-secondary"
        title="Reprocessar todas as metas"
      >
        <i class="fas fa-cog"></i>
      </button>
    </form>
    {% if goals %}
    <a
      href="{{ url_for('goals.suggest_investments') }}"
      class="btn btn-success"
    >
      <i class="fas fa-chart-pie"></i> Sugerir Investimentos
    </a>
    {% endif %}
    <a href="{{ url_for('goals.create') }}" class="btn btn-primary">
      <i class="fas fa-plus"></i> Nova Meta
    </a>
  </div>
</div>

<!-- Seção de Patrimônio Total -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Patrimônio Total</h5>
        <div class="row">
          <div class="col-md-3">
            <div class="patrimonio-item">
              <i class="fas fa-money-bill-wave text-success"></i>
              {{ format_currency(patrimonio.valor_brl if patrimonio else none,
              'BRL') }}
            </div>
          </div>
          <div class="col-md-3">
            <div class="patrimonio-item">
              <i class="fas fa-dollar-sign text-primary"></i>
              {{ format_currency(patrimonio.valor_usd if patrimonio else none,
              'USD') }}
            </div>
          </div>
          <div class="col-md-3">
            <div class="patrimonio-item">
              <i class="fas fa-euro-sign text-warning"></i>
              {{ format_currency(patrimonio.valor_eur if patrimonio else none,
              'EUR') }}
            </div>
          </div>
          <div class="col-md-3">
            <div class="patrimonio-item">
              <i class="fab fa-bitcoin text-warning"></i>
              {{ format_currency(patrimonio.valor_btc if patrimonio else none,
              'BTC') }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Lista de Metas -->
<div class="row">
  {% for goal in goals %}
  <div class="col-12 col-md-6 col-lg-4 mb-4">
    <div class="card bg-dark text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <h5 class="card-title mb-0">
            <a
              href="{{ url_for('goals.details', goal_id=goal.id) }}"
              class="text-white text-decoration-none"
            >
              {{ goal.title }}
            </a>
          </h5>
          <div class="d-flex align-items-center gap-2">
            {% if goal.has_pending %}
            <i
              class="fas fa-exclamation-circle text-warning"
              title="Esta meta possui transações pendentes de confirmação"
              style="font-size: 1.2em"
            ></i>
            {% endif %} {% if goal.is_debt %}
            <span class="badge bg-danger"> {{ goal.currency }} </span>
            {% else %} {% if goal.currency == 'BRL' %}
            <span class="badge bg-success"> {{ goal.currency }} </span>
            {% elif goal.currency == 'USD' %}
            <span class="badge bg-primary"> {{ goal.currency }} </span>
            {% elif goal.currency == 'EUR' %}
            <span class="badge bg-success"> {{ goal.currency }} </span>
            {% else %}
            <span class="badge bg-info"> {{ goal.currency }} </span>
            {% endif %} {% endif %}
          </div>
        </div>

        <div class="goal-dates">
          <small class="text-muted"
            >Criado em: {{ goal.created_at.strftime('%d/%m/%Y') }}</small
          >
          {% if goal.target_date %}
          <br />
          <small class="text-muted"
            >Meta para: {{ goal.target_date.strftime('%d/%m/%Y') }}</small
          >
          {% endif %}
        </div>

        <div class="progress-wrapper">
          <div class="progress">
            {% if goal.is_debt %} {% set current_debt = goal.current_value %} {%
            set percentage = ((goal.initial_value - current_debt) /
            goal.initial_value * 100)|round|int if goal.initial_value > 0 else 0
            %} {% else %} {% if goal.target_value %} {% set percentage =
            (goal.current_value / goal.target_value * 100)|round|int if
            goal.target_value > 0 else 0 %} {% else %} {% set percentage =
            (goal.current_value / (goal.target_percentage or 100) *
            100)|round|int %} {% endif %} {% endif %}

            <div
              class="progress-bar {% if goal.is_debt %}bg-danger{% endif %}"
              role="progressbar"
              style="width: {{ percentage }}%;"
              aria-valuenow="{{ percentage }}"
              aria-valuemin="0"
              aria-valuemax="100"
            >
              {{ percentage }}%
            </div>
          </div>
        </div>

        <div class="goal-values">
          <div class="goal-value-row">
            <span class="goal-value-label">Valor Atual:</span>
            <span
              class="goal-value-amount {% if goal.is_debt %}text-danger{% endif %}"
            >
              {{ format_currency(goal.current_value, goal.currency) }}
            </span>
          </div>
          {% if goal.is_debt %}
          <div class="goal-value-row">
            <span class="goal-value-label">Valor Inicial da Dívida:</span>
            <span class="goal-value-amount">
              {{ format_currency(goal.initial_value, goal.currency) }}
            </span>
          </div>
          {% endif %} {% if (goal.target_value or goal.target_percentage) and
          not goal.is_debt %}
          <div class="goal-value-row">
            <span class="goal-value-label">Meta:</span>
            <span class="goal-value-amount">
              {% if goal.target_percentage %} {{ goal.target_percentage }}% {%
              else %} {{ format_currency(goal.target_value, goal.currency) }} {%
              endif %}
            </span>
          </div>
          {% endif %}
        </div>

        {% if goal.children %}
        <div class="mt-3">
          <h6>Submetas:</h6>
          <ul class="list-group">
            {% for child in goal.children %}
            <a
              href="{{ url_for('goals.details', goal_id=child.id) }}"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            >
              {{ child.title }}
              <span class="badge bg-success rounded-pill">
                {{ format_currency(child.current_value, child.currency) }}
              </span>
            </a>

            <!-- Modal de Detalhes da Submeta -->
            <div
              class="modal fade"
              id="detailsModal{{ child.id }}"
              tabindex="-1"
              aria-hidden="true"
            >
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">{{ child.title }}</h5>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <p>
                      <strong>Descrição:</strong> {{ child.description or 'Sem
                      descrição' }}
                    </p>
                    <p>
                      <strong>Data de Criação:</strong> {{
                      child.created_at.strftime('%d/%m/%Y') }}
                    </p>
                    {% if child.target_date %}
                    <p>
                      <strong>Data Alvo:</strong> {{
                      child.target_date.strftime('%d/%m/%Y') }}
                    </p>
                    {% endif %}
                    <p>
                      <strong>Tipo:</strong> {% if child.is_debt %}Dívida{% else
                      %}Investimento{% endif %}
                    </p>
                    <p><strong>Moeda:</strong> {{ child.currency }}</p>
                    {% if child.target_value %}
                    <p>
                      <strong>Valor Alvo:</strong> {{
                      format_currency(child.target_value, child.currency) }}
                    </p>
                    {% endif %} {% if child.target_percentage %}
                    <p>
                      <strong>Percentual Alvo:</strong> {{
                      '{:,.2f}'.format(child.target_percentage).replace('.',
                      ',') }}%
                    </p>
                    {% endif %}
                    <p>
                      <strong>Valor Atual:</strong> {{
                      format_currency(child.current_value, child.currency) }}
                    </p>

                    {% if child.children %}
                    <hr />
                    <h6>Submetas:</h6>
                    <ul class="list-group">
                      {% for subchild in child.children %}
                      <li
                        class="list-group-item d-flex justify-content-between align-items-center"
                        style="cursor: pointer"
                        data-bs-toggle="modal"
                        data-bs-target="#detailsModal{{ subchild.id }}"
                        data-bs-dismiss="modal"
                      >
                        {{ subchild.title }}
                        <span class="badge bg-primary rounded-pill">
                          {{ format_currency(subchild.current_value,
                          subchild.currency) }}
                        </span>
                      </li>
                      {% endfor %}
                    </ul>
                    {% endif %}
                  </div>
                  <div class="modal-footer">
                    <div class="d-flex gap-2 w-100">
                      <a
                        href="{{ url_for('goals.edit', goal_id=child.id) }}"
                        class="btn btn-warning flex-grow-1"
                      >
                        <i class="fas fa-edit"></i> Editar
                      </a>
                      {% if not child.children %}
                      <button
                        type="button"
                        class="btn btn-primary flex-grow-1"
                        data-bs-toggle="modal"
                        data-bs-target="#updateValueModal{{ child.id }}"
                        data-bs-dismiss="modal"
                      >
                        <i class="fas fa-coins"></i> Atualizar Saldo
                      </button>
                      {% endif %}
                      <button
                        type="button"
                        class="btn btn-danger flex-grow-1"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal{{ child.id }}"
                        data-bs-dismiss="modal"
                      >
                        <i class="fas fa-trash"></i> Excluir
                      </button>
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                      >
                        Fechar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modais das sub-submetas (movidos para fora do modal pai) -->
            {% if child.children %} {% for subchild in child.children %}
            <!-- Modal de Detalhes da Sub-submeta -->
            <div
              class="modal fade"
              id="detailsModal{{ subchild.id }}"
              tabindex="-1"
              aria-hidden="true"
            >
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">{{ subchild.title }}</h5>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <p>
                      <strong>Descrição:</strong> {{ subchild.description or
                      'Sem descrição' }}
                    </p>
                    <p>
                      <strong>Data de Criação:</strong> {{
                      subchild.created_at.strftime('%d/%m/%Y') }}
                    </p>
                    {% if subchild.target_date %}
                    <p>
                      <strong>Data Alvo:</strong> {{
                      subchild.target_date.strftime('%d/%m/%Y') }}
                    </p>
                    {% endif %}
                    <p>
                      <strong>Tipo:</strong> {% if subchild.is_debt %}Dívida{%
                      else %}Investimento{% endif %}
                    </p>
                    <p><strong>Moeda:</strong> {{ subchild.currency }}</p>
                    {% if subchild.target_value %}
                    <p>
                      <strong>Valor Alvo:</strong> {{
                      format_currency(subchild.target_value, subchild.currency)
                      }}
                    </p>
                    {% endif %} {% if subchild.target_percentage %}
                    <p>
                      <strong>Percentual Alvo:</strong> {{
                      '{:,.2f}'.format(subchild.target_percentage).replace('.',
                      ',') }}%
                    </p>
                    {% endif %}
                    <p>
                      <strong>Valor Atual:</strong> {{
                      format_currency(subchild.current_value, subchild.currency)
                      }}
                    </p>
                  </div>
                  <div class="modal-footer">
                    <div class="d-flex gap-2 w-100">
                      <a
                        href="{{ url_for('goals.edit', goal_id=subchild.id) }}"
                        class="btn btn-warning flex-grow-1"
                      >
                        <i class="fas fa-edit"></i> Editar
                      </a>
                      {% if not subchild.children %}
                      <button
                        type="button"
                        class="btn btn-primary flex-grow-1"
                        data-bs-toggle="modal"
                        data-bs-target="#updateValueModal{{ subchild.id }}"
                        data-bs-dismiss="modal"
                      >
                        <i class="fas fa-coins"></i> Atualizar Saldo
                      </button>
                      {% endif %}
                      <button
                        type="button"
                        class="btn btn-danger flex-grow-1"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal{{ subchild.id }}"
                        data-bs-dismiss="modal"
                      >
                        <i class="fas fa-trash"></i> Excluir
                      </button>
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                      >
                        Fechar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal de Confirmação de Exclusão da Sub-submeta -->
            <div
              class="modal fade"
              id="deleteModal{{ subchild.id }}"
              tabindex="-1"
              aria-hidden="true"
            >
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <p>
                      Tem certeza que deseja excluir a submeta "{{
                      subchild.title }}"?
                    </p>
                    {% if subchild.children %}
                    <div class="alert alert-warning">
                      <strong>Atenção!</strong> Esta submeta possui outras
                      submetas que também serão excluídas.
                    </div>
                    {% endif %}
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Cancelar
                    </button>
                    <form
                      method="POST"
                      action="{{ url_for('goals.delete', goal_id=subchild.id) }}"
                      style="display: inline"
                    >
                      <button type="submit" class="btn btn-danger">
                        Confirmar Exclusão
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal de Atualização de Saldo da Sub-submeta -->
            <div
              class="modal fade"
              id="updateValueModal{{ subchild.id }}"
              tabindex="-1"
              aria-hidden="true"
            >
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">
                      Atualizar Saldo - {{ subchild.title }}
                    </h5>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                  </div>
                  <form
                    method="POST"
                    action="{{ url_for('goals.update_value', goal_id=subchild.id) }}"
                    id="updateValueForm{{ subchild.id }}"
                    data-currency="{{ subchild.currency }}"
                  >
                    <div class="modal-body">
                      <div class="mb-3">
                        <label for="value{{ subchild.id }}" class="form-label"
                          >Novo Saldo</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="value{{ subchild.id }}"
                          name="value"
                          required
                        />
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                      >
                        Cancelar
                      </button>
                      <button type="submit" class="btn btn-primary">
                        Salvar
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            {% endfor %} {% endif %}

            <!-- Modal de Confirmação de Exclusão da Submeta -->
            <div
              class="modal fade"
              id="deleteModal{{ child.id }}"
              tabindex="-1"
              aria-hidden="true"
            >
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <p>
                      Tem certeza que deseja excluir a submeta "{{ child.title
                      }}"?
                    </p>
                    {% if child.children %}
                    <div class="alert alert-warning">
                      <strong>Atenção!</strong> Esta submeta possui outras
                      submetas que também serão excluídas.
                    </div>
                    {% endif %}
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Cancelar
                    </button>
                    <form
                      method="POST"
                      action="{{ url_for('goals.delete', goal_id=child.id) }}"
                      style="display: inline"
                    >
                      <button type="submit" class="btn btn-danger">
                        Confirmar Exclusão
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal de Atualização de Saldo da Submeta -->
            <div
              class="modal fade"
              id="updateValueModal{{ child.id }}"
              tabindex="-1"
              aria-hidden="true"
            >
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">
                      Atualizar Saldo - {{ child.title }}
                    </h5>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                  </div>
                  <form
                    method="POST"
                    action="{{ url_for('goals.update_value', goal_id=child.id) }}"
                    id="updateValueForm{{ child.id }}"
                    data-currency="{{ child.currency }}"
                  >
                    <div class="modal-body">
                      <div class="mb-3">
                        <label for="value{{ child.id }}" class="form-label"
                          >Novo Saldo</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="value{{ child.id }}"
                          name="value"
                          required
                        />
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                      >
                        Cancelar
                      </button>
                      <button type="submit" class="btn btn-primary">
                        Salvar
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>

      <div class="action-buttons d-flex flex-column">
        <a
          href="{{ url_for('goals.details', goal_id=goal.id) }}"
          class="btn btn-primary"
        >
          <i class="fas fa-info-circle"></i> Detalhes
        </a>
      </div>
    </div>
  </div>

  <!-- Modal de Detalhes -->
  <div
    class="modal fade"
    id="detailsModal{{ goal.id }}"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ goal.title }}</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>
            <strong>Descrição:</strong> {{ goal.description or 'Sem descrição'
            }}
          </p>
          <p>
            <strong>Data de Criação:</strong> {{
            goal.created_at.strftime('%d/%m/%Y') }}
          </p>
          {% if goal.target_date %}
          <p>
            <strong>Data Alvo:</strong> {{ goal.target_date.strftime('%d/%m/%Y')
            }}
          </p>
          {% endif %}
          <p>
            <strong>Tipo:</strong> {% if goal.is_debt %}Dívida{% else
            %}Investimento{% endif %}
          </p>
          <p><strong>Moeda:</strong> {{ goal.currency }}</p>
          {% if goal.target_value %}
          <p>
            <strong>Valor Alvo:</strong> {{ format_currency(goal.target_value,
            goal.currency) }}
          </p>
          {% endif %} {% if goal.target_percentage %}
          <p>
            <strong>Percentual Alvo:</strong> {{
            '{:,.2f}'.format(goal.target_percentage).replace('.', ',') }}%
          </p>
          {% endif %}
          <p>
            <strong>Valor Atual:</strong> {{ format_currency(goal.current_value,
            goal.currency) }}
          </p>
        </div>
        <div class="modal-footer">
          <div class="d-flex gap-2 w-100">
            <a
              href="{{ url_for('goals.edit', goal_id=goal.id) }}"
              class="btn btn-warning flex-grow-1"
            >
              <i class="fas fa-edit"></i> Editar
            </a>
            {% if not goal.children %}
            <button
              type="button"
              class="btn btn-primary flex-grow-1"
              data-bs-toggle="modal"
              data-bs-target="#updateValueModal{{ goal.id }}"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-coins"></i> Atualizar Saldo
            </button>
            <button
              type="button"
              class="btn btn-success flex-grow-1"
              data-bs-toggle="modal"
              data-bs-target="#investModal{{ goal.id }}"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-arrow-up"></i> Investir
            </button>
            <button
              type="button"
              class="btn btn-info flex-grow-1"
              data-bs-toggle="modal"
              data-bs-target="#withdrawModal{{ goal.id }}"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-arrow-down"></i> Resgatar
            </button>
            {% endif %}
            <button
              type="button"
              class="btn btn-danger flex-grow-1"
              data-bs-toggle="modal"
              data-bs-target="#deleteModal{{ goal.id }}"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-trash"></i> Excluir
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Fechar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmação de Exclusão -->
  <div
    class="modal fade"
    id="deleteModal{{ goal.id }}"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar Exclusão</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>Tem certeza que deseja excluir a meta "{{ goal.title }}"?</p>
          {% if goal.children %}
          <div class="alert alert-warning">
            <strong>Atenção!</strong> Esta meta possui submetas que também serão
            excluídas.
          </div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
          <form
            method="POST"
            action="{{ url_for('goals.delete', goal_id=goal.id) }}"
            style="display: inline"
          >
            <button type="submit" class="btn btn-danger">
              Confirmar Exclusão
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Atualização de Saldo -->
  <div
    class="modal fade"
    id="updateValueModal{{ goal.id }}"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Atualizar Saldo - {{ goal.title }}</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <form
          method="POST"
          action="{{ url_for('goals.update_value', goal_id=goal.id) }}"
          id="updateValueForm{{ goal.id }}"
          data-currency="{{ goal.currency }}"
        >
          <div class="modal-body">
            <div class="mb-3">
              <label for="value{{ goal.id }}" class="form-label"
                >Novo Saldo</label
              >
              <input
                type="text"
                class="form-control"
                id="value{{ goal.id }}"
                name="value"
                required
              />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de Investimento -->
  <div
    class="modal fade"
    id="investModal{{ goal.id }}"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Investir em {{ goal.title }}</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <form
          method="POST"
          action="{{ url_for('goals.invest', goal_id=goal.id) }}"
          id="investForm{{ goal.id }}"
          data-currency="{{ goal.currency }}"
        >
          <div class="modal-body">
            <div class="mb-3">
              <label for="invest_value{{ goal.id }}" class="form-label"
                >Valor do Investimento</label
              >
              <input
                type="text"
                class="form-control"
                id="invest_value{{ goal.id }}"
                name="value"
                required
              />
            </div>
            <div class="mb-3">
              <label for="invest_date{{ goal.id }}" class="form-label"
                >Data do Investimento</label
              >
              <input
                type="date"
                class="form-control"
                id="invest_date{{ goal.id }}"
                name="date"
                value="{{ today.strftime('%Y-%m-%d') }}"
                required
              />
            </div>
            <div class="mb-3">
              <label for="invest_description{{ goal.id }}" class="form-label"
                >Descrição (opcional)</label
              >
              <textarea
                class="form-control"
                id="invest_description{{ goal.id }}"
                name="description"
                rows="2"
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-success">
              Confirmar Investimento
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de Resgate -->
  <div
    class="modal fade"
    id="withdrawModal{{ goal.id }}"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Resgatar de {{ goal.title }}</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <form
          method="POST"
          action="{{ url_for('goals.withdraw', goal_id=goal.id) }}"
          id="withdrawForm{{ goal.id }}"
          data-currency="{{ goal.currency }}"
        >
          <div class="modal-body">
            <div class="mb-3">
              <label for="withdraw_value{{ goal.id }}" class="form-label"
                >Valor do Resgate</label
              >
              <input
                type="text"
                class="form-control"
                id="withdraw_value{{ goal.id }}"
                name="value"
                required
              />
            </div>
            <div class="mb-3">
              <label for="withdraw_date{{ goal.id }}" class="form-label"
                >Data do Resgate</label
              >
              <input
                type="date"
                class="form-control"
                id="withdraw_date{{ goal.id }}"
                name="date"
                value="{{ today.strftime('%Y-%m-%d') }}"
                required
              />
            </div>
            <div class="mb-3">
              <label for="withdraw_description{{ goal.id }}" class="form-label"
                >Descrição (opcional)</label
              >
              <textarea
                class="form-control"
                id="withdraw_description{{ goal.id }}"
                name="description"
                rows="2"
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-info">
              Confirmar Resgate
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% else %}
  <div class="col-12">
    <div class="alert alert-info">
      Você ainda não tem metas cadastradas. Clique em "Nova Meta" para começar!
    </div>
  </div>
  {% endfor %}
</div>

<!-- Gráfico de Evolução do Patrimônio -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Evolução do Patrimônio</h5>
        <div
          class="chart-container"
          style="position: relative; width: 100%; height: 400px"
        >
          <canvas id="patrimonioChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->

{% endblock %} {% block scripts %}

<script defer>
  function initializePatrimonioChart() {
      const canvas = document.getElementById('patrimonioChart');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const labels = {{ dados_grafico.datas | default([]) | tojson }};

      if (labels.length === 0) {
          ctx.font = '16px Arial';
          ctx.fillStyle = '#e0e0e0';
          ctx.textAlign = 'center';
          ctx.fillText('Ainda não há histórico de patrimônio', canvas.width / 2, canvas.height / 2);
          return;
      }

      new Chart(ctx, {
          type: 'line',
          data: {
              labels: labels,
              datasets: [
                  {
                      label: 'BRL',
                      data: {{ dados_grafico.brl | default([]) | tojson }},
                      borderColor: '#00ff9d',
                      backgroundColor: '#00ff9d20',
                      tension: 0.4
                  },
                  {
                      label: 'USD',
                      data: {{ dados_grafico.usd | default([]) | tojson }},
                      borderColor: '#00b7ff',
                      backgroundColor: '#00b7ff20',
                      tension: 0.4
                  },
                  {
                      label: 'EUR',
                      data: {{ dados_grafico.eur | default([]) | tojson }},
                      borderColor: '#ffbb00',
                      backgroundColor: '#ffbb0020',
                      tension: 0.4
                  },
                  {
                      label: 'BTC',
                      data: {{ dados_grafico.btc | default([]) | tojson }},
                      borderColor: '#ff0055',
                      backgroundColor: '#ff005520',
                      tension: 0.4
                  }
              ]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'top',
                      labels: {
                          color: '#e0e0e0'
                      }
                  }
              },
              scales: {
                  x: {
                      grid: {
                          color: 'rgba(255, 255, 255, 0.1)'
                      },
                      ticks: {
                          color: '#e0e0e0'
                      }
                  },
                  y: {
                      grid: {
                          color: 'rgba(255, 255, 255, 0.1)'
                      },
                      ticks: {
                          color: '#e0e0e0'
                      }
                  }
              }
          }
      });
  }

  // Função principal de inicialização
  function initializeList() {
      // Inicializa os tooltips do Bootstrap
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.forEach(function (tooltipTriggerEl) {
          new bootstrap.Tooltip(tooltipTriggerEl);
      });

      // Inicializa as máscaras de moeda
      document.querySelectorAll('.currency-input').forEach(function(input) {
          const currency = input.dataset.currency;
          if (!currency) return;

          const masks = {
              BRL: {
                  mask: 'R$ num',
                  blocks: {
                      num: {
                          mask: Number,
                          scale: 2,
                          padFractionalZeros: true,
                          thousandsSeparator: '.',
                          radix: ',',
                          mapToRadix: ['.'],
                          min: 0,
                          normalizeZeros: true
                      }
                  }
              },
              USD: {
                  mask: '$ num',
                  blocks: {
                      num: {
                          mask: Number,
                          scale: 2,
                          padFractionalZeros: true,
                          thousandsSeparator: ',',
                          radix: '.',
                          min: 0,
                          normalizeZeros: true
                      }
                  }
              },
              EUR: {
                  mask: '€ num',
                  blocks: {
                      num: {
                          mask: Number,
                          scale: 2,
                          padFractionalZeros: true,
                          thousandsSeparator: '.',
                          radix: ',',
                          mapToRadix: ['.'],
                          min: 0,
                          normalizeZeros: true
                      }
                  }
              },
              BTC: {
                  mask: '₿ num',
                  blocks: {
                      num: {
                          mask: Number,
                          scale: 8,
                          padFractionalZeros: false,
                          radix: '.',
                          min: 0,
                          normalizeZeros: true
                      }
                  }
              }
          };

          IMask(input, masks[currency]);
      });

      // Inicializa o gráfico de patrimônio
      initializePatrimonioChart();
  }

  // Inicializa quando a página estiver completamente carregada
  if (document.readyState === 'complete') {
      initializeList();
  } else {
      window.addEventListener('load', initializeList);
  }
</script>

<style>
  .footer {
    background-color: #1a1a1a;
    border-top: 1px solid #333;
    position: relative;
    bottom: 0;
    width: 100%;
  }
</style>
{% endblock %}
